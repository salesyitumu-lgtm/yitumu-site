---
import Base from '../../layouts/Base.astro';
import { getCollection } from 'astro:content';
import { assertLocale, pickByLocale } from './_util';

function normalizeImages(images: any): string[] {
  if (!Array.isArray(images)) return [];
  return images
    .map((x) => {
      if (typeof x === 'string') return x;
      if (x && typeof x === 'object') return x.image || x.src || x.url || '';
      return '';
    })
    .filter(Boolean);
}

export async function getStaticPaths() {
  const langs = ['en','es','fr','de','it'];
  const catsAll = await getCollection('categories');
  const enabled = catsAll.filter(c => c.data.enabled);

  const paths: any[] = [];
  for (const lang of langs) {
    for (const c of enabled) paths.push({ params: { lang, category: c.slug } });
  }
  return paths;
}

const { lang, category } = Astro.params;
if (!lang || !assertLocale(lang)) throw new Error('Invalid lang');

const settings = (await getCollection('settings'))[0]?.data;
const ui = {
  blog: pickByLocale(settings ?? {}, lang, 'nav_blog') ?? 'Blog',
  about: pickByLocale(settings ?? {}, lang, 'nav_about') ?? 'About',
  contact: pickByLocale(settings ?? {}, lang, 'nav_contact') ?? 'Contact',
  langLabel: pickByLocale(settings ?? {}, lang, 'lang_label') ?? 'Language'
};

const catsAll = await getCollection('categories');
const cat = catsAll.find(c => c.slug === category);
if (!cat || !cat.data.enabled) return new Response('Not Found', { status: 404 });

const nav = catsAll
  .filter(c => c.data.enabled)
  .sort((a,b)=> (a.data.order ?? 999) - (b.data.order ?? 999))
  .map(c => ({
    slug: c.slug,
    label: (c.data as any)[`name_${lang}`] ?? c.data.name_en,
    href: `/${lang}/${c.slug}/`
  }));

const productsAll = await getCollection('products');
const products = productsAll
  .filter(p => p.data.status === 'active' && p.data.category === category)
  .sort((a,b)=> (a.data.order ?? 999) - (b.data.order ?? 999))
  .map(p => {
    const imgs = normalizeImages(p.data.images);
    const title = (p.data as any)[`title_${lang}`] ?? p.data.title_en ?? p.slug;
    const features = ((p.data as any)[`features_${lang}`] ?? p.data.features_en ?? []) as string[];
    const body = ((p.data as any)[`body_${lang}`] ?? p.data.body_en ?? '') as string;
    const excerpt = body
      ? body.replace(/<[^>]+>/g, '').replace(/\s+/g,' ').trim().slice(0, 80)
      : '';
    return {
      slug: p.slug,
      title,
      cover: imgs[0] ?? null,
      model: p.data.model ?? '',
      moq: p.data.moq ?? '',
      features,
      excerpt,
      href: `/${lang}/p/${p.slug}/`
    };
  });

const catName = (cat.data as any)[`name_${lang}`] ?? cat.data.name_en;
---

<Base title={catName} lang={lang} nav={nav} settings={settings} ui={ui}>
  <section class="hero">
    <div class="grid">
      <div class="card">
        <h1>{catName}</h1>
        <p class="note">Products: {products.length}</p>
      </div>

      <div class="card">
        {products.length ? (
          <div class="cols" style="gap:14px;">
            {products.map(p => (
              <a class="col" href={p.href} style="display:block;text-decoration:none;">
                <div style="border:1px solid var(--border);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.02)">
                  <div style="aspect-ratio: 16/10; background: rgba(255,255,255,.03); display:flex; align-items:center; justify-content:center;">
                    {p.cover ? (
                      <img src={p.cover} alt={p.title} style="width:100%;height:100%;object-fit:cover;display:block;" loading="lazy" />
                    ) : (
                      <span class="note">No Image</span>
                    )}
                  </div>

                  <div style="padding:14px">
                    <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;">
                      <strong style="line-height:1.2">{p.title}</strong>
                      <span class="badge">View</span>
                    </div>

                    <div class="muted" style="margin-top:8px;font-size:14px;">
                      {p.model ? <span>Model: {p.model}</span> : null}
                      {p.moq ? <span>{p.model ? ' · ' : ''}MOQ: {p.moq}</span> : null}
                    </div>

                    {p.features?.length ? (
                      <ul class="muted" style="margin:10px 0 0 18px;font-size:14px;">
                        {p.features.slice(0,3).map(f => <li>{f}</li>)}
                      </ul>
                    ) : p.excerpt ? (
                      <p class="muted" style="margin-top:10px;font-size:14px;">{p.excerpt}{p.excerpt.length >= 80 ? '…' : ''}</p>
                    ) : (
                      <p class="note" style="margin-top:10px;font-size:14px;">No features yet.</p>
                    )}

                    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
                      <span class="note">View Details</span>
                      <span class="note">Request a Quote</span>
                    </div>
                  </div>
                </div>
              </a>
            ))}
          </div>
        ) : (
          <p>No active products in this category yet. Add products in /admin → 产品.</p>
        )}
      </div>
    </div>
  </section>
</Base>
